# Continuous Integration (CI)

Continuous integration is the practice of frequently merging code changes.

But frequent merges cause difficulties:
- What if the code doesn't compile after a merge
- What if someone broke something
- It would be a lof of work to check these things on every merge

The solution is to automate this process.

## How CI works ?
We use a CI server which executes a build that automatically prepares/compiles the code and runs automated tests.

Usually, the CI server automatically detects code changes in source control and run the build whenever there is a change

If something is wrong, the build fails. The team can get immediate feedback if their change broke something. It can take in form of emails.

Merging frequently throughout the day and getting quick feedback means that if you broke something, you broke it with your changes within the last couple hours. This is much easier to identify/fix than if you broke something with your changes from a week ago!

We will be using Jenkins as our CI server.

## Setting up CI server

Let's set up Jenkins:
```console
sudo yum -y remove java
sudo yum -y install java-1.8.0-openjdk
sudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat-stable/jenkins.repo
sudo rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.key
sudo yum -y install jenkins-2.121.1
sudo systemctl enable jenkins
sudo systemctl start jenkins
```

Instead of "sudo yum -y install jenkins-2.121.1", do "sudo yum -y install jenkins"


Go to <your server address>:8080 in a browser,
in my case, it is http://10.211.55.4:8080/
and on the home page, you will get this message:
```console
Unlock Jenkins
To ensure Jenkins is securely set up by the administrator, a password has been written to the log (not sure where to find it?) and this file on the server:
/var/lib/jenkins/secrets/initialAdminPassword
Please copy the password from either location and paste it below.
```

Thus on the server, copy/paste the password required that you can find in /var/lib/jenkins/secrets/initialAdminPassword

Then, choose the default setting for the set up

Register the adminstrator account:
Username: jenkins
password: jenkins

After that, login to <your server address>:8080
in my case, http://10.211.55.4:8080.
In the case, there is an error, type the url <your server address>:8080/restart
  
 
## Setting up Jenkins Projects
Jenkins projects are at the core of doing any kind of automation in Jenkins. 
A Jenkins project is the configuration which controls what a piece of Jenkins automation does and when it executes.

It will demonstrate how to set up a freestyle project that pulls application source code from GitHub and executes build automation against it. 

We are going to set up a CI build for the train schedule app found at https://github.com/linuxacademy/cicd-pipeline-train-schedule-jenkins.
- This build will check out the code from GitHub
- Run the gradle build automation that is packaged with the source code


Go your Jenkins homepage,
click on "New Item"
Enter the name for the jenkins project
Then choose "Freestyle project" as a project type
Now I am ready to set up my project to pull the source code from git.
From the source code management, select Git and paste the url from gitHub (https://github.com/linuxacademy/cicd-pipeline-train-schedule-jenkins). I don't need to set up any crudential because this git repository is publicly readable.

Now, I go ahead and implementing my build step. Click on add build step
This build is a gradle build. So i am going to choose "invoke gradle script"
and call the gradle build that is built in source code. Now this source code used the gradle wrapper.
Put in Tasks: build. What is going to do is it will call "./gradlew build" to actually execute the gradle build

In the "post-build actions" section,
I am going to archive and artefact,
this particular build is going to generate a zip archive of the code
So I am going to archive as a jenkins artefact. So after the build runs, I can access the zip files that was created as a result of that build. So I am going to click on "Add post-build actions" and select "Archive the artefacts".
The zip file which is going to be generated by the gradle build is (Files to archive): dist/trainSchedule.zip.


Now, I finished configuring my project
and can actually executing the build, by clicking "Build now"

If I click on console output, I can watch the console output from the build himself
and see that gradle is currently in the process of running

If I go back to the train schedule project page,
I can see that it archives my train-schedule to zip file



This is the output expected in the console:
```console
Started by user Jenkins
Building in workspace /var/lib/jenkins/workspace/train-schedule
 > git rev-parse --is-inside-work-tree # timeout=10
Fetching changes from the remote Git repository
 > git config remote.origin.url https://github.com/linuxacademy/cicd-pipeline-train-schedule-jenkins # timeout=10
Fetching upstream changes from https://github.com/linuxacademy/cicd-pipeline-train-schedule-jenkins
 > git --version # timeout=10
 > git fetch --tags --progress https://github.com/linuxacademy/cicd-pipeline-train-schedule-jenkins +refs/heads/*:refs/remotes/origin/*
 > git rev-parse refs/remotes/origin/master^{commit} # timeout=10
 > git rev-parse refs/remotes/origin/origin/master^{commit} # timeout=10
Checking out Revision 1603f84d1f50794623c71673920fc3111280045f (refs/remotes/origin/master)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f 1603f84d1f50794623c71673920fc3111280045f
Commit message: "specify a newer version of node and npm"
 > git rev-list --no-walk 1603f84d1f50794623c71673920fc3111280045f # timeout=10
[Gradle] - Launching build.
[train-schedule] $ /var/lib/jenkins/workspace/train-schedule/gradlew build
Starting a Gradle Daemon (subsequent builds will be faster)

:nodeSetup UP-TO-DATE
:npmSetup UP-TO-DATE

:npmInstall UP-TO-DATE

:npm_test

> cicd-pipeline-train-schedule-git@0.0.0 test /var/lib/jenkins/workspace/train-schedule
> mocha



  Index Page
[0mGET / [32m200 [0m250.550 ms - 829[0m
    âœ“ renders successfully (275ms)

  Trains API
[0mGET /trains [32m200 [0m5.289 ms - 1093[0m
    âœ“ returns data successfully


  2 passing (318ms)

:npm_build
:zip UP-TO-DATE
:build UP-TO-DATE

BUILD SUCCESSFUL in 11s
6 actionable tasks: 2 executed, 4 up-to-date
Build step 'Invoke Gradle script' changed build result to SUCCESS

Archiving artifacts
Finished: SUCCESS
```

# Automatically trigerring builds as soon as commit to git

Some teams have a scheduled builds that runs one a week, one a day, twice a day.
However, the most efficient and immediate way is to have a trigger.

We are going to use Webhooks which is event notifications made from one application to another over http.

In jenkins, we can use webhooks to have Github notify Jenkins as soon as the code in GitHub changes.
Jenkins can respond by automatically running the build to implement any changes.

We can configure Jenkins to automatically create and manage webhooks in GitHub.
So we must give jenkins access to an API token that allows to access the gitHub API.

Configurin webhooks in Jenkins is realatively easy. We need to:
- Create an access token in GitHub that has permission to read and create webhooks
- Add a GitHub server in Jenkins for GitHub.com
- Create a jenkins credential with the token and configure the GitHub server configuration to use it
- Check "Manage Hooks" for the GitHub server configuration
- In the project configuration, under "Build triggers", select "GitHub hook trigger for GITScm polling"

### On GitHub
click Settings >> Developer settings >> Personal access tokens >> Generate new token
Select the right permission: admin:repo_hook >> write:repo_hook and read:repo_hook

### On Jenkins
Click Manage Jenkins >> Configure system
In the section GitHub, select Git server, name: GitHub, Credentials: Add jenkins
Select Kind: Secret text, Secret: "Enter the api key of GitHub", ID: github_key, Description: GitHubKey
Then Credential: GitHubKey, check "Manage hooks", click on "test connection"

I ve just set up my Jenkins server to be able to authenticate with GitHub.

Click on the project >> Configure. 
- In the section "Source Code Management" >> Git >> Repository URL: https://github.com/TerryV8/cicd-pipeline-train-schedule-jenkins
- In the section  "Build triggers", select "Github hook trigger for GITScm polling"


